{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
    <style>
    h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 10px;
    }

    #counter {
        text-align: center;
        color: #34495e;
        font-size: 1.1em;
        margin-bottom: 15px;
    }

    #field {
        position: relative;
        width: 70%;
        height: 550px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px dashed #cfd8dc;
        margin: auto;
    }

    .box {
        position: absolute;
        width: 170px;
        object-fit: contain;
        cursor: pointer;
        --angle: 0deg;
        transform: rotate(var(--angle));
        transition: transform 0.3s, filter 0.3s;
    }

    .box:hover {
        transform: rotate(var(--angle)) scale(1.15);
        filter: drop-shadow(0 0 10px gold);
    }

    .box.opened {
        opacity: 0.35;
        filter: grayscale(100%);
        transform: none;
        cursor: default;
    }

    .gift {
        width: 350px;
        display: block;
        margin: 10px auto 0;
    }

    #modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #modal-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        max-width: 90%;
    }
    </style>
    <img
            src="/static/lab9/lights.png"
            style="width: 15%; margin: auto; display: block;"
        >

    <h1>üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è üéÅ</h1>

    <div id="counter">
        –û—Å—Ç–∞–ª–æ—Å—å –Ω–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫: {{ unopened }}<br>
        –û—Ç–∫—Ä—ã—Ç–æ –≤–∞–º–∏: {{ opened_count }} / 3
    </div>

    <div id="field">
    {% for box in boxes %}
        <img
            src="{{ box.box_image }}"
            class="box {% if box.opened %}opened{% endif %}"
            style="left: {{ box.x }}%; top: {{ box.y }}%;"
            data-id="{{ box.id }}"
        >
    {% endfor %}
    </div>

    <div id="modal">
        <div id="modal-content">
            <h2 id="greeting"></h2>
            <img id="gift" class="gift">
            <br><br>
            <button onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
    const totalBoxes = {{ boxes|length }};

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É–≥–ª–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ—Ä–æ–±–∫–∏
    document.querySelectorAll('.box').forEach(box => {
        const id = parseInt(box.dataset.id);
        const angle = (id * 13 % 21) - 10;
        box.style.setProperty('--angle', angle + 'deg');

        // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–∞–∂–¥—É—é –∫–æ—Ä–æ–±–∫—É
        box.addEventListener('click', () => openBox(box));
    });

    function openBox(box) {
        if (box.classList.contains('opened')) return;

        fetch('/lab9/api/open', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: box.dataset.id})
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            box.classList.add('opened');
            document.getElementById('greeting').innerText = data.greeting;
            document.getElementById('gift').src = data.gift_image;
            document.getElementById('modal').style.display = 'flex';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ —Å—Ä–∞–∑—É
            const counterEl = document.getElementById('counter');
            counterEl.innerHTML = `–û—Å—Ç–∞–ª–æ—Å—å –Ω–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫: ${totalBoxes - data.opened_count}<br>
                                   –û—Ç–∫—Ä—ã—Ç–æ –≤–∞–º–∏: ${data.opened_count} / 3`;
        });
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }
    </script>
{% endblock %}
